<template>
  <HoppSmartModal
    v-if="show"
    dialog
    :title="t('collection.properties')"
    :full-width-body="true"
    @close="hideModal"
  >
    <template #body>
      <HoppSmartTabs
        v-model="selectedOptionTab"
        styles="sticky overflow-x-auto flex-shrink-0 bg-primary top-0 z-10 !-py-4"
        render-inactive-tabs
      >
        <HoppSmartTab :id="'headers'" :label="`${t('tab.headers')}`">
          <HttpHeaders
            v-model="editableCollection"
            :is-collection-property="true"
            @change-tab="changeOptionTab"
          />
          <div
            class="bg-bannerInfo px-4 py-2 flex items-center sticky bottom-0"
          >
            <icon-lucide-info class="svg-icons mr-2" />
            {{ t("helpers.collection_properties_header") }}
          </div>
        </HoppSmartTab>
        <HoppSmartTab
          :id="'authorization'"
          :label="`${t('tab.authorization')}`"
        >
          <HttpAuthorization
            v-model="editableCollection.auth"
            :is-collection-property="true"
            :is-root-collection="editingProperties?.isRootCollection"
            :inherited-properties="editingProperties?.inheritedProperties"
            :source="source"
            @generate-o-auth-token="onGenerateOAuthToken"
          />
          <div
            class="bg-bannerInfo px-4 py-2 flex items-center sticky bottom-0"
          >
            <icon-lucide-info class="svg-icons mr-2" />
            {{ t("helpers.collection_properties_authorization") }}
          </div>
        </HoppSmartTab>
      </HoppSmartTabs>
    </template>
    <template #footer>
      <span class="flex space-x-2">
        <HoppButtonPrimary
          :label="t('action.save')"
          :loading="loadingState"
          outline
          @click="saveEditedCollection"
        />
        <HoppButtonSecondary
          :label="t('action.cancel')"
          outline
          filled
          @click="hideModal"
        />
      </span>
    </template>
  </HoppSmartModal>
</template>

<script setup lang="ts">
import { watch, ref } from "vue"
import { useI18n } from "@composables/i18n"
import { HoppCollection, HoppRESTAuth, HoppRESTHeaders } from "@hoppscotch/data"
import { RESTOptionTabs } from "../http/RequestOptions.vue"
import { clone } from "lodash-es"
import { HoppInheritedProperty } from "~/helpers/types/HoppInheritedProperties"
import { PersistenceService } from "~/services/persistence"
import { useService } from "dioc/vue"
import { grantTypesInvolvingRedirect } from "~/services/oauth/oauth.service"

const persistenceService = useService(PersistenceService)
const t = useI18n()

type EditingProperties = {
  collection: Partial<HoppCollection> | null
  isRootCollection: boolean
  path: string
  inheritedProperties?: HoppInheritedProperty
}

const props = withDefaults(
  defineProps<{
    show: boolean
    loadingState: boolean
    editingProperties: EditingProperties | null
    source: "REST" | "GraphQL"
  }>(),
  {
    show: false,
    loadingState: false,
    editingProperties: null,
  }
)

const emit = defineEmits<{
  (
    e: "set-collection-properties",
    newCollection: Omit<EditingProperties, "inheritedProperties">
  ): void
  (e: "hide-modal"): void
}>()

const editableCollection = ref<{
  headers: HoppRESTHeaders
  auth: HoppRESTAuth
}>({
  headers: [],
  auth: {
    authType: "inherit",
    authActive: false,
  },
})

const selectedOptionTab = ref("headers")

const changeOptionTab = (tab: RESTOptionTabs) => {
  selectedOptionTab.value = tab
}

watch(
  () => props.show,
  (show) => {
    if (show && props.editingProperties?.collection) {
      editableCollection.value.auth = clone(
        props.editingProperties.collection.auth as HoppRESTAuth
      )
      editableCollection.value.headers = clone(
        props.editingProperties.collection.headers as HoppRESTHeaders
      )
    } else {
      editableCollection.value = {
        headers: [],
        auth: {
          authType: "inherit",
          authActive: false,
        },
      }
    }
  }
)

const saveEditedCollection = () => {
  if (!props.editingProperties) return
  const finalCollection = clone(editableCollection.value)
  const collection = {
    path: props.editingProperties.path,
    collection: {
      ...props.editingProperties.collection,
      ...finalCollection,
    },
    isRootCollection: props.editingProperties.isRootCollection,
  }
  emit("set-collection-properties", collection as EditingProperties)
}

const hideModal = () => {
  emit("hide-modal")
}

const onGenerateOAuthToken = () => {
  const localOAuthTempConfig =
    persistenceService.getLocalConfig("oauth_temp_config")

  if (!localOAuthTempConfig || !props.editingProperties) {
    return
  }

  const persistedOAuthConfig = JSON.parse(localOAuthTempConfig)

  // Only Grant Types involving redirects require persisting associated information
  if (
    persistedOAuthConfig.grant_type &&
    !grantTypesInvolvingRedirect.includes(persistedOAuthConfig.grant_type)
  ) {
    return
  }

  // Write the collection object to `localStorage` to retrieve later while redirecting back post the OAuth flow
  if (persistedOAuthConfig.context.type === "collection-properties") {
    persistenceService.setLocalConfig(
      "oauth_temp_config",
      JSON.stringify({
        ...persistedOAuthConfig,
        context: {
          ...persistedOAuthConfig.context,
          metadata: {
            collection: props.editingProperties.collection,
            collectionID: props.editingProperties.path,
          },
        },
      })
    )
  }
}
</script>
